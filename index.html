<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Barcode Nutrition Scanner</title>
    <style>
        /* Keep all your existing CSS as-is */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border: 2px solid black;
            overflow: hidden;
        }

        .header {
            background: black;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid black;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: white;
            border-bottom: 2px solid black;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: black;
        }

        .status-dot.offline {
            background: white;
            border: 2px solid black;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            padding: 30px;
        }

        .scan-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .scan-input {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .scan-input input {
            flex: 1;
            padding: 12px;
            font-size: 1em;
            border: 2px solid black;
            outline: none;
        }

        .scan-input input:focus {
            border: 3px solid black;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            border: 2px solid black;
            cursor: pointer;
            background: white;
        }

        .btn-primary {
            background: black;
            color: white;
        }

        .btn-primary:hover {
            background: white;
            color: black;
        }

        .btn-secondary {
            background: white;
            color: black;
        }

        .btn-secondary:hover {
            background: black;
            color: white;
        }

        .results-container {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .product-card {
            background: white;
            border: 2px solid black;
            padding: 20px;
            margin-bottom: 20px;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .product-title {
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
        }

        .product-barcode {
            background: white;
            padding: 5px 15px;
            border: 2px solid black;
            font-family: monospace;
            font-size: 0.9em;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .nutrition-item {
            background: white;
            padding: 15px;
            text-align: center;
            border: 2px solid black;
        }

        .nutrition-label {
            font-size: 0.9em;
            color: black;
            margin-bottom: 5px;
        }

        .nutrition-value {
            font-size: 1.8em;
            font-weight: bold;
            color: black;
        }

        .nutrition-unit {
            font-size: 0.8em;
            color: black;
        }

        .alert-box {
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid black;
            background: white;
        }

        .alert-warning {
            background: white;
            border: 3px solid black;
            color: black;
        }

        .alert-success {
            background: white;
            border: 2px solid black;
            color: black;
        }

        .alert-error {
            background: black;
            border: 2px solid black;
            color: white;
        }

        .alternatives-section {
            background: white;
            border: 2px solid black;
            padding: 20px;
            margin-top: 20px;
        }

        .alternatives-title {
            font-size: 1.2em;
            color: black;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .alternative-item {
            background: white;
            padding: 15px;
            border: 1px solid black;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recent-scans {
            margin-top: 30px;
        }

        .recent-scans h3 {
            margin-bottom: 15px;
            color: black;
        }

        .recent-item {
            background: white;
            padding: 12px 20px;
            border: 2px solid black;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .recent-item:hover {
            background: black;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .spinner {
            border: 4px solid white;
            border-top: 4px solid black;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .health-score {
            display: inline-block;
            padding: 8px 20px;
            border: 2px solid black;
            font-weight: bold;
            font-size: 1.1em;
        }

        .score-good {
            background: white;
            color: black;
        }

        .score-medium {
            background: white;
            color: black;
        }

        .score-bad {
            background: black;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: black;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Smart Barcode Nutrition Scanner</h1>
            <p>Scan products to view nutrition information instantly</p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Online - Connected to Database</span>
            </div>
            <span id="lastUpdate">Last updated: Never</span>
        </div>

        <div class="main-content">
            <div class="scan-section">
                <h2>Scan or Enter Barcode</h2>
                <div class="scan-input">
                    <input type="text" id="barcodeInput" placeholder="Enter barcode number or scan..." autofocus>
                    <button class="btn btn-primary" onclick="scanBarcode()">Search</button>
                </div>
                <button class="btn btn-secondary" onclick="startCamera()">üì∑ Use Camera</button>
            </div>

            <div class="loading" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Retrieving nutrition information...</p>
            </div>

            <div class="results-container" id="resultsContainer">
                <!-- Results will be dynamically inserted here -->
            </div>

            <div class="recent-scans" id="recentScans">
                <h3>Recent Scans</h3>
                <div id="recentList">
                    <p style="color: #6c757d; text-align: center;">No recent scans yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const backendURL = 'http://192.168.137.54/smartscanner/getProduct.php';

        const sampleProducts = {
            '1234567890': {
                name: 'Organic Whole Wheat Bread',
                barcode: '1234567890',
                calories: 250,
                protein: 8,
                carbs: 45,
                fat: 3,
                fiber: 6,
                sugar: 4,
                sodium: 380,
                allergens: ['gluten', 'wheat'],
                healthScore: 'good',
                alternatives: [
                    { name: 'Multigrain Bread', calories: 230 },
                    { name: 'Sourdough Bread', calories: 240 }
                ]
            },
            '9876543210': {
                name: 'Chocolate Chip Cookies',
                barcode: '9876543210',
                calories: 480,
                protein: 5,
                carbs: 65,
                fat: 22,
                fiber: 2,
                sugar: 32,
                sodium: 420,
                allergens: ['gluten', 'dairy', 'eggs'],
                healthScore: 'bad',
                alternatives: [
                    { name: 'Oatmeal Cookies', calories: 350 },
                    { name: 'Rice Cakes', calories: 80 }
                ]
            }
        };

        let recentScans = [];

        document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') scanBarcode();
        });

        async function scanBarcode() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            if (!barcode) return showAlert('Please enter a barcode number', 'error');

            showLoading();

            // Try backend first
            try {
                const response = await fetch(`${backendURL}?barcode=${barcode}`);
                if (!response.ok) throw new Error('Backend not reachable');

                const data = await response.json();
                
                if (data && Object.keys(data).length > 0) {
                    // Convert allergens string to array if needed
                    if (data.allergens && typeof data.allergens === 'string') {
                        data.allergens = data.allergens.split(',');
                    }
                    // Convert healthier alternative
                    if (data.healthier_alternative) {
                        data.alternatives = [{ name: data.healthier_alternative, calories: '-' }];
                    } else data.alternatives = data.alternatives || [];
                    data.healthScore = data.healthScore || 'medium';

                    displayResults(data);
                    addToRecentScans(data);
                    return;
                }
                throw new Error('Product not found');
            } catch (err) {
                console.warn(err);
                // Use sample data if backend fails
                const product = sampleProducts[barcode];
                if (product) {
                    displayResults(product);
                    addToRecentScans(product);
                } else {
                    hideLoading();
                    showAlert('Product not found in database or offline. Try another barcode.', 'error');
                }
            }
        }

        function displayResults(product) {
            hideLoading();
            const container = document.getElementById('resultsContainer');
            container.style.display = 'block';

            let allergenHTML = '';
            if (product.allergens && product.allergens.length > 0) {
                allergenHTML = `
                    <div class="alert-box alert-warning">
                        <strong>‚ö†Ô∏è Allergen Alert:</strong> Contains ${product.allergens.join(', ')}
                    </div>
                `;
            }

            let alternativesHTML = '';
            if (product.alternatives && product.alternatives.length > 0) {
                alternativesHTML = `
                    <div class="alternatives-section">
                        <div class="alternatives-title">üí° Healthier Alternatives</div>
                        ${product.alternatives.map(alt => `
                            <div class="alternative-item">
                                <span>${alt.name}</span>
                                <span style="font-weight: bold;">${alt.calories} cal</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            const scoreClass = product.healthScore === 'good' ? 'score-good' :
                               product.healthScore === 'medium' ? 'score-medium' : 'score-bad';

            container.innerHTML = `
                <div class="product-card">
                    <div class="product-header">
                        <div>
                            <div class="product-title">${product.name}</div>
                            <span class="health-score ${scoreClass}">
                                ${product.healthScore === 'good' ? '‚úì Healthy Choice' : 
                                  product.healthScore === 'medium' ? '‚ö† Moderate' : '‚úó Less Healthy'}
                            </span>
                        </div>
                        <div class="product-barcode">${product.barcode}</div>
                    </div>

                    ${allergenHTML}

                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <div class="nutrition-label">Calories</div>
                            <div class="nutrition-value">${product.calories}<span class="nutrition-unit">kcal</span></div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Protein</div>
                            <div class="nutrition-value">${product.protein}<span class="nutrition-unit">g</span></div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Carbs</div>
                            <div class="nutrition-value">${product.carbs}<span class="nutrition-unit">g</span></div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Fat</div>
                            <div class="nutrition-value">${product.fat}<span class="nutrition-unit">g</span></div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Fiber</div>
                            <div class="nutrition-value">${product.fiber}<span class="nutrition-unit">g</span></div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Sugar</div>
                            <div class="nutrition-value">${product.sugar}<span class="nutrition-unit">g</span></div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Sodium</div>
                            <div class="nutrition-value">${product.sodium}<span class="nutrition-unit">mg</span></div>
                        </div>
                    </div>

                    ${alternativesHTML}
                </div>
            `;
            updateLastUpdate();
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function addToRecentScans(product) {
            recentScans = recentScans.filter(item => item.barcode !== product.barcode);
            recentScans.unshift({ name: product.name, barcode: product.barcode, time: new Date().toLocaleTimeString() });
            if (recentScans.length > 5) recentScans.pop();
            updateRecentScans();
        }

        function updateRecentScans() {
            const container = document.getElementById('recentList');
            if (recentScans.length === 0) {
                container.innerHTML = '<p style="color: black; text-align: center;">No recent scans yet</p>';
                return;
            }
            container.innerHTML = recentScans.map(item => `
                <div class="recent-item" onclick="searchByBarcode('${item.barcode}')">
                    <span>${item.name}</span>
                    <span style="font-size: 0.9em;">${item.time}</span>
                </div>
            `).join('');
        }

        function searchByBarcode(barcode) {
            document.getElementById('barcodeInput').value = barcode;
            scanBarcode();
        }

        function startCamera() {
            showAlert('Camera scanning feature will be integrated with OpenCV backend', 'success');
        }

        function showLoading() { document.getElementById('loadingSpinner').style.display = 'block'; document.getElementById('resultsContainer').style.display = 'none'; }
        function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }
        function showAlert(message, type) {
            const alertClass = type === 'error' ? 'alert-error' : type === 'warning' ? 'alert-warning' : 'alert-success';
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-box ${alertClass}`;
            alertDiv.textContent = message;
            document.querySelector('.scan-section').appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 4000);
        }
        function updateLastUpdate() { document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`; }
    </script>
</body>
</html>
